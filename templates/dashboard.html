<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <link rel="manifest" href="/static/manifest.json">
    <title>BullBear.AI - Signal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Error Banner -->
    <div id="error-banner"
        class="fixed top-0 left-0 right-0 bg-rose-600 text-white p-2 text-center text-xs font-bold hidden z-[100]">
        An error occurred: <span id="error-text"></span>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        // Global Error Handler
        window.onerror = function (msg, url, line, col, error) {
            const banner = document.getElementById('error-banner');
            const text = document.getElementById('error-text');
            if (banner && text) {
                banner.classList.remove('hidden');
                text.innerText = `${msg} (Line ${line})`;
            }
            console.error("Global Error:", msg, error);
            return false;
        };

        // Check Dependencies
        if (typeof ApexCharts === 'undefined') {
            document.getElementById('error-banner').classList.remove('hidden');
            document.getElementById('error-text').innerText = "Failed to load ApexCharts Library. Check internet connection.";
        }


    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
        }

        .call-bg {
            background-color: rgba(6, 78, 59, 0.4);
            color: #a7f3d0;
        }

        /* Emerald-900/40 */
        .put-bg {
            background-color: rgba(127, 29, 29, 0.4);
            color: #fecaca;
        }

        /* Rose-900/40 */

        .atm-row {
            background: linear-gradient(90deg, rgba(234, 88, 12, 0.1) 0%, rgba(234, 88, 12, 0.2) 50%, rgba(234, 88, 12, 0.1) 100%) !important;
            border-left: 2px solid #f97316;
            border-right: 2px solid #f97316;
        }

        /* Sticky Header for Tables */
        th {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        /* Fade transition */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .active-nav-mobile {
            color: #38bdf8;
            /* sky-400 */
        }
    </style>
</head>

<body
    class="bg-slate-950 text-slate-200 font-sans min-h-screen flex flex-col overflow-hidden selection:bg-indigo-500/30">

    <!-- Top Navigation Bar -->
    <header class="glass-header border-b border-slate-800 shadow-lg shrink-0 z-30">
        <div class="max-w-full mx-auto px-6 py-3 flex justify-between items-center">

            <!-- Left: Branding & Nav -->
            <div class="flex items-center space-x-8">
                <div class="flex items-center gap-2 group cursor-pointer">
                    <div
                        class="w-8 h-8 rounded-lg bg-gradient-to-tr from-amber-500 to-rose-600 flex items-center justify-center font-bold text-white shadow-lg group-hover:scale-110 transition">
                        B</div>
                    <span
                        class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-rose-400">
                        MyBull<span class="font-light text-rose-400">AndBearFire</span>
                    </span>
                </div>

                <!-- Nav Tabs (Hidden on Mobile, Visible on Desktop) -->
                <nav
                    class="hidden md:flex space-x-1 bg-slate-900/50 p-1 rounded-lg border border-slate-800 backdrop-blur-sm">
                    <button onclick="switchView('overview')" id="btn-overview"
                        class="px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 transform scale-105">Overview</button>
                    <button onclick="switchView('analysis')" id="btn-analysis"
                        class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800">Deep
                        Dive</button>
                    <button onclick="switchView('charts')" id="btn-charts"
                        class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800">Charts</button>
                    <button onclick="switchView('signals')" id="btn-signals"
                        class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800">Signals</button>
                </nav>
            </div>

            <!-- Center: Consolidated Signals -->
            <div id="header-signals" class="hidden md:flex gap-6 text-xs font-medium tracking-wide">
                <!-- Injected via JS -->
                <span class="text-slate-600 animate-pulse">Scanning market...</span>
            </div>

            <!-- Right: Controls -->
            <div class="flex items-center gap-4">
                <!-- Symbol Select -->
                <div class="relative group">
                    <select id="symbolSelect"
                        class="appearance-none bg-slate-900 border border-slate-700 text-slate-200 text-sm rounded-lg px-4 py-2 pr-8 focus:ring-2 focus:ring-indigo-500/50 outline-none cursor-pointer hover:border-slate-600 transition"
                        onchange="updateUI()">
                        <option value="NIFTY">NIFTY 50</option>
                        <option value="BANKNIFTY">BANK NIFTY</option>
                        <option value="FINNIFTY">FIN NIFTY</option>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>

                <!-- Fyers Connect Status -->
                <!-- Fyers Connect Status -->
                <a href="{{ '/api/logout' if fyers_connected else '/connect' }}"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-800 bg-slate-900/50 hover:bg-slate-800 transition text-xs font-medium group"
                    title="{{ 'Disconnect' if fyers_connected else 'Connect to Fyers' }}">
                    <span class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full {{ 'bg-emerald-400' if fyers_connected else 'bg-rose-500' }} opacity-75"></span>
                        <span
                            class="relative inline-flex rounded-full h-2 w-2 {{ 'bg-emerald-500' if fyers_connected else 'bg-rose-600' }}"></span>
                    </span>
                    <span
                        class="{{ 'text-emerald-400' if fyers_connected else 'text-rose-400' }} group-hover:text-white transition-colors hidden md:inline">
                        {{ 'Live (Logout)' if fyers_connected else 'Offline' }}
                    </span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main
        class="flex-grow relative overflow-hidden bg-[url('https://grainy-gradients.vercel.app/noise.svg')] bg-opacity-20">

        <!-- View 1: Dashboard Overview (Market Summary) -->
        <div id="view-overview"
            class="absolute inset-0 p-4 md:p-8 overflow-auto flex flex-col items-center justify-start pt-20 md:pt-16">

            <div class="w-full max-w-6xl mb-8 fade-in-up">
                <h2
                    class="text-2xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-slate-200 via-slate-100 to-slate-400 mb-2">
                    Market Overview</h2>
                <p class="text-slate-500">Real-time sentiment and key metrics across indices.</p>
            </div>

            <!-- Active Alerts Section REMOVED -->

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-6xl">
                <!-- Cards injected via JS -->
                <div id="summary-cards" class="contents">
                    <!-- Loading State -->
                    <div class="col-span-3 h-48 rounded-2xl glass animate-pulse flex items-center justify-center">
                        <div class="flex flex-col items-center gap-2">
                            <div
                                class="w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin">
                            </div>
                            <span class="text-slate-500 font-medium">Fetching Live Data...</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- View 2: Detailed Analysis (Full Chain) -->
        <div id="view-analysis" class="absolute inset-0 p-4 overflow-hidden hidden flex flex-col">

            <!-- Analysis Header -->
            <div class="glass px-6 py-4 rounded-xl mb-4 shrink-0 flex justify-between items-center shadow-lg">
                <div class="flex gap-8 items-center">
                    <div class="text-right">
                        <span class="block text-[10px] text-slate-500 uppercase">Spot Price</span>
                        <span id="spot-price-analysis"
                            class="font-mono font-bold text-2xl md:text-3xl text-yellow-400 drop-shadow-md">---.--</span>
                    </div>
                </div>

                <!-- Full Table -->
                <div
                    class="flex-grow glass rounded-xl shadow-2xl overflow-hidden border border-slate-800 flex flex-col">
                    <div class="overflow-auto custom-scrollbar flex-grow">
                        <table class="w-max min-w-full text-xs text-center border-collapse whitespace-nowrap">
                            <thead
                                class="bg-slate-900/90 text-slate-400 uppercase tracking-widest text-[9px] font-semibold backdrop-blur">
                                <tr>
                                    <th colspan="8"
                                        class="py-2 bg-gradient-to-b from-emerald-950/50 to-emerald-900/20 border-b border-emerald-900/30 text-emerald-400">
                                        CALLS (Bullish)</th>
                                    <th rowspan="2"
                                        class="py-2 bg-slate-950 border-x border-slate-800 text-slate-200 w-24 z-30 shadow-xl">
                                        Strike</th>
                                    <th colspan="8"
                                        class="py-2 bg-gradient-to-b from-rose-950/50 to-rose-900/20 border-b border-rose-900/30 text-rose-400">
                                        PUTS (Bearish)</th>
                                </tr>
                                <tr class="bg-slate-900 border-b border-slate-800">
                                    <th class="py-3 px-2 hidden sm:table-cell">OI</th>
                                    <th class="py-3 px-2 hidden sm:table-cell">OI Chg</th>
                                    <th class="py-3 px-2 hidden md:table-cell text-slate-600">Vol</th>
                                    <th class="py-3 px-2 hidden lg:table-cell text-slate-600">IV</th>
                                    <th class="py-3 px-2 hidden lg:table-cell text-slate-600">Delta</th>
                                    <th class="py-3 px-2">Trend</th>
                                    <th class="py-3 px-2">LTP</th>
                                    <th class="py-3 px-2 border-r border-slate-800 hidden sm:table-cell">Chg</th>

                                    <th class="py-3 px-2 border-l border-slate-800">LTP</th>
                                    <th class="py-3 px-2 hidden sm:table-cell">Chg</th>
                                    <th class="py-3 px-2">Trend</th>
                                    <th class="py-3 px-2 hidden lg:table-cell text-slate-600">Delta</th>
                                    <th class="py-3 px-2 hidden lg:table-cell text-slate-600">IV</th>
                                    <th class="py-3 px-2 hidden md:table-cell text-slate-600">Vol</th>
                                    <th class="py-3 px-2 hidden sm:table-cell">OI Chg</th>
                                    <th class="py-3 px-2 hidden sm:table-cell">OI</th>
                                </tr>
                            </thead>
                            <tbody id="full-chain-body" class="divide-y divide-slate-800/50 font-mono text-slate-300">
                                <tr>
                                    <td colspan="17" class="p-10 text-center text-slate-500 italic">Initializing Data
                                        Feed...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div> <!-- Close Table Container -->
            </div> <!-- Close Header (Active/Glass) -->
        </div> <!-- Close view-analysis -->

        <div id="view-signals" class="absolute inset-0 p-4 overflow-y-auto hidden flex flex-col pt-20 pb-24">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto w-full">

                <!-- Signal Cockpit (Gauges) -->
                <div
                    class="glass p-5 rounded-2xl border border-white/5 relative bg-gradient-to-br from-slate-900/50 to-slate-900/80 shadow-xl backdrop-blur-md">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-bold text-slate-100 text-lg tracking-tight">Signal Cockpit</h3>
                            <p class="text-xs text-slate-400 font-mono mt-0.5 tracking-wide">AI ALGO â€¢ LIVE</p>
                        </div>
                        <div class="flex gap-2">
                            <span
                                class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)] animate-pulse"></span>
                        </div>
                    </div>

                    <!-- Gauge Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- NIFTY -->
                        <div
                            class="bg-slate-800/30 rounded-xl p-4 border border-white/5 relative group hover:border-white/10 transition-colors flex flex-col items-center">
                            <div class="w-full flex justify-between items-start mb-2">
                                <span
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">NIFTY</span>
                            </div>
                            <div id="signal-NIFTY" class="-my-4 transform scale-110"></div>
                            <div id="reasons-NIFTY" class="flex flex-col gap-1 items-center justify-center mt-2 w-full">
                            </div>
                        </div>

                        <!-- BANKNIFTY -->
                        <div
                            class="bg-slate-800/30 rounded-xl p-4 border border-white/5 relative group hover:border-white/10 transition-colors flex flex-col items-center">
                            <div class="w-full flex justify-between items-start mb-2">
                                <span
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">BANKNIFTY</span>
                            </div>
                            <div id="signal-BANKNIFTY" class="-my-4 transform scale-110"></div>
                            <div id="reasons-BANKNIFTY"
                                class="flex flex-col gap-1 items-center justify-center mt-2 w-full"></div>
                        </div>

                        <!-- FINNIFTY -->
                        <div
                            class="bg-slate-800/30 rounded-xl p-4 border border-white/5 relative group hover:border-white/10 transition-colors flex flex-col items-center">
                            <div class="w-full flex justify-between items-start mb-2">
                                <span
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">FINNIFTY</span>
                            </div>
                            <div id="signal-FINNIFTY" class="-my-4 transform scale-110"></div>
                            <div id="reasons-FINNIFTY"
                                class="flex flex-col gap-1 items-center justify-center mt-2 w-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Signal History Feed -->
                <div
                    class="glass p-5 rounded-2xl border border-white/5 flex-1 min-h-[400px] flex flex-col relative bg-gradient-to-b from-slate-900/50 to-slate-900/80">
                    <h3 class="font-bold text-slate-200 text-sm mb-4 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Signal History
                        <p class="text-xs text-slate-500 font-mono">OI Change (Intraday)</p>
                </div>
                <div class="flex gap-4 text-[10px] font-mono bg-slate-900/50 p-2 rounded-lg border border-slate-800">
                    <div class="flex items-center gap-1"><span
                            class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/30"></span>
                        Put
                        (Bull)</div>
                    <div class="flex items-center gap-1"><span
                            class="w-2.5 h-2.5 rounded-full bg-rose-500 shadow-lg shadow-rose-500/30"></span>
                        Call
                        (Bear)</div>
                </div>
            </div>

            <!-- Chart 1: NIFTY -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-slate-300 mb-2 pl-2 border-l-2 border-indigo-500">
                    NIFTY</h3>
                <div
                    class="rounded-xl border border-slate-800 shadow-xl bg-slate-900/60 p-2 h-64 overflow-hidden relative backdrop-blur-sm">
                    <div id="chart-NIFTY" class="w-full h-full"></div>
                </div>
            </div>

            <!-- Chart 2: BANKNIFTY -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-slate-300 mb-2 pl-2 border-l-2 border-teal-500">
                    BANKNIFTY</h3>
                <div
                    class="rounded-xl border border-slate-800 shadow-xl bg-slate-900/60 p-2 h-64 overflow-hidden relative backdrop-blur-sm">
                    <div id="chart-BANKNIFTY" class="w-full h-full"></div>
                </div>
            </div>

            <!-- Chart 3: FINNIFTY -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-slate-300 mb-2 pl-2 border-l-2 border-emerald-500">
                    FINNIFTY</h3>
                <div
                    class="rounded-xl border border-slate-800 shadow-xl bg-slate-900/60 p-2 h-64 overflow-hidden relative backdrop-blur-sm">
                    <div id="chart-FINNIFTY" class="w-full h-full"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Padding for Nav -->
        <div class="h-20 shrink-0 md:hidden"></div>
    </main>

    <!-- Bottom Mobile Navigation -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-slate-950/90 backdrop-blur-xl border-t border-slate-800 z-50 md:hidden flex justify-around items-center pb-safe box-border">
        <button onclick="switchView('overview')" id="mob-btn-overview"
            class="flex-1 py-3 flex flex-col items-center justify-center gap-1 text-slate-500 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                </path>
            </svg>
            <span class="text-[10px] font-bold tracking-wide">Home</span>
        </button>
        <button onclick="switchView('analysis')" id="mob-btn-analysis"
            class="flex-1 py-3 flex flex-col items-center justify-center gap-1 text-slate-500 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z">
                </path>
            </svg>
            <span class="text-[10px] font-bold tracking-wide">Deep Dive</span>
        </button>
        <button onclick="switchView('charts')" id="mob-btn-charts"
            class="flex-1 py-3 flex flex-col items-center justify-center gap-1 text-slate-500 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
            </svg>
            <span class="text-[10px] font-bold tracking-wide">Charts</span>
        </button>
        <button onclick="switchView('signals')" id="mob-btn-signals"
            class="flex-1 py-3 flex flex-col items-center justify-center gap-1 text-slate-500 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z">
                </path>
            </svg>
            <span class="text-[10px] font-bold tracking-wide">Signals</span>
        </button>
        <a href="{{ '/api/logout' if fyers_connected else '/connect' }}"
            class="flex-1 py-3 flex flex-col items-center justify-center gap-1 text-slate-500 transition-colors">
            <svg class="w-6 h-6 {{ 'text-emerald-500' if fyers_connected else 'text-rose-500' }}" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                {% if fyers_connected %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                {% else %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                </path>
                {% endif %}
            </svg>
            <span
                class="text-[10px] font-bold tracking-wide {{ 'text-emerald-500' if fyers_connected else 'text-rose-500' }}">{{
                'Status' if fyers_connected else 'Login' }}</span>
        </a>
        <button id="install-btn"
            class="hidden flex-1 py-3 flex-col items-center justify-center gap-1 text-amber-500 transition-colors"
            onclick="installPWA()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            <span class="text-[10px] font-bold tracking-wide">Install</span>
        </button>
    </nav>

    <!-- Unified Logic -->
    <script>
        let currentView = 'overview'; // 'overview' | 'analysis'
        let currentSymbol = 'NIFTY';

        // --- View Switching ---
        function switchView(view) {
            currentView = view;

            // Toggle Content
            const vOverview = document.getElementById('view-overview');
            const vAnalysis = document.getElementById('view-analysis');
            const vSignals = document.getElementById('view-signals');
            const vCharts = document.getElementById('view-charts');

            [vOverview, vAnalysis, vSignals, vCharts].forEach(el => el.classList.add('hidden'));

            if (view === 'overview') vOverview.classList.remove('hidden');
            else if (view === 'analysis') vAnalysis.classList.remove('hidden');
            else if (view === 'signals') vSignals.classList.remove('hidden');
            else if (view === 'charts') vCharts.classList.remove('hidden');

            // Toggle Buttons (Desktop)
            const btnOver = document.getElementById('btn-overview');
            const btnAnal = document.getElementById('btn-analysis');
            const btnCharts = document.getElementById('btn-charts');

            // Toggle Buttons (Mobile)
            const mobOver = document.getElementById('mob-btn-overview');
            const mobAnal = document.getElementById('mob-btn-analysis');
            const mobCharts = document.getElementById('mob-btn-charts');
            const mobSig = document.getElementById('mob-btn-signals');

            const activeClass = "px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 transform scale-105";
            const inactiveClass = "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-slate-800";

            // Reset Mobile
            [mobOver, mobAnal, mobSig, mobCharts].forEach(b => {
                b.classList.remove('text-indigo-400');
                b.classList.add('text-slate-500');
            });

            // Reset Desktop
            [btnOver, btnAnal, btnCharts].forEach(b => { if (b) b.className = inactiveClass; });

            if (view === 'overview') {
                if (btnOver) btnOver.className = activeClass;
                mobOver.classList.add('text-indigo-400');
            } else if (view === 'analysis') {
                if (btnAnal) btnAnal.className = activeClass;
                mobAnal.classList.add('text-indigo-400');
            } else if (view === 'charts') {
                if (btnCharts) btnAnal.className = activeClass; // This was a bug, should be btnCharts
                if (btnCharts) btnCharts.className = activeClass;
                mobCharts.classList.add('text-indigo-400');
            } else if (view === 'signals') {
                mobSig.classList.add('text-indigo-400');
            }
            updateUI();
        }

        // --- Data Fetching ---
        async function updateUI() {
            currentSymbol = document.getElementById('symbolSelect').value;

            // Update Text
            document.querySelectorAll('.current-symbol-text').forEach(el => el.innerText = currentSymbol);

            try {
                const res = await fetch('/api/option_chain');
                const data = await res.json();

                if (data) {
                    updateHeaderSignals(data);

                    if (currentView === 'overview') {
                        renderSummaryCards(data);
                    } else {
                        if (data[currentSymbol]) {
                            const symbolData = data[currentSymbol];

                            if (currentView === 'analysis') {
                                updateSpotPrice(symbolData.spot);
                                renderFullChain(symbolData.chain);
                                updateAnalysisHeader(symbolData);
                            } else if (currentView === 'signals') {
                                updateSignals(); // Gauges
                                fetchSignalHistory(); // Feed
                            } else if (currentView === 'charts') {
                                renderAllCharts();
                            }
                        }
                    }
                }
            } catch (e) {
                console.error("Fetch Error:", e);
            }
        }

        // --- Sub-Renderers ---

        function updateSpotPrice(price) {
            const p = price ? price.toFixed(2) : '---.--';
            document.getElementById('spot-price-analysis').innerText = p;
        }

        function updateHeaderSignals(data) {
            const container = document.getElementById('header-signals');
            let html = '';
            ['NIFTY', 'BANKNIFTY', 'FINNIFTY'].forEach(sym => {
                if (data[sym] && data[sym].sentiment) {
                    const s = data[sym].sentiment;
                    let color = 'text-slate-500';
                    if (s === 'Bullish') color = 'text-emerald-400 font-bold';
                    if (s === 'Bearish') color = 'text-rose-400 font-bold';
                    html += `<div class="flex items-center gap-2"><span class="text-slate-400">${sym}</span> <span class="${color}">${s}</span></div>`;
                }
            });
            container.innerHTML = html || '<span class="text-slate-600">No signals</span>';
        }

        function updateAnalysisHeader(data) {
            const pcrEl = document.getElementById('pcr-value');
            const sentiEl = document.getElementById('sentiment-value');
            const mpEl = document.getElementById('max-pain-value');

            pcrEl.innerText = data.pcr || '-';
            sentiEl.innerText = data.sentiment || '-';
            if (mpEl) mpEl.innerText = (data.max_pain || '-');

            sentiEl.className = 'font-bold text-lg';
            if (data.sentiment === 'Bullish') sentiEl.classList.add('text-emerald-400');
            else if (data.sentiment === 'Bearish') sentiEl.classList.add('text-rose-400');
            else sentiEl.classList.add('text-slate-400');
        }

        /* renderAlerts removed */

        // --- Render: Summary Cards (Overview) ---
        function renderSummaryCards(data) {
            // renderAlerts(data); // Removed

            const container = document.getElementById('summary-cards');
            container.innerHTML = '';

            const symbols = ['NIFTY', 'BANKNIFTY', 'FINNIFTY'];

            symbols.forEach((sym, index) => {
                const d = data[sym] || {};
                const spot = d.spot ? d.spot.toFixed(2) : '---.--';
                const ch = d.ch || 0;
                const chp = d.chp || 0;
                const pcr = d.pcr !== undefined ? d.pcr : 0; // Ensure number
                const sentiment = d.sentiment || 'Neutral';
                const maxPain = d.max_pain || '-';

                // Colors
                const priceColor = ch >= 0 ? 'text-emerald-400' : 'text-rose-400';
                const sign = ch >= 0 ? '+' : '';

                let sentiColor = 'text-slate-400';
                let tileBgClass = 'glass border-slate-700/50'; // Default Neutral
                let glowColor = 'shadow-indigo-500/10';

                if (sentiment === 'Bullish') {
                    sentiColor = 'text-emerald-400';
                    // Stronger Gradient & Border & Shadow
                    tileBgClass = 'bg-gradient-to-br from-slate-900 via-emerald-900/60 to-slate-900 border-2 border-emerald-500/50 shadow-[0_0_30px_rgba(16,185,129,0.3)]';
                    glowColor = 'shadow-emerald-400/30';
                }
                if (sentiment === 'Bearish') {
                    sentiColor = 'text-rose-400';
                    // Stronger Gradient & Border & Shadow
                    tileBgClass = 'bg-gradient-to-br from-slate-900 via-rose-900/60 to-slate-900 border-2 border-rose-500/50 shadow-[0_0_30px_rgba(244,63,94,0.3)]';
                    glowColor = 'shadow-rose-400/30';
                }

                // Stagger Animation
                const delay = index * 100;

                // Refined Card Design
                const cardHtml = `
                    <div class="${tileBgClass} rounded-2xl p-5 shadow-2xl hover:${glowColor} transition-all duration-300 transform hover:-translate-y-1 relative overflow-hidden group fade-in-up border backdrop-blur-md" style="animation-delay: ${delay}ms">
                        
                        <!-- Background Accent -->
                        <div class="absolute -right-6 -top-6 opacity-[0.05] group-hover:opacity-[0.1] transition duration-700 rotate-12 scale-150">
                             <span class="text-9xl font-black text-white select-none filter blur-sm">${sym[0]}</span>
                        </div>

                        <!-- Header -->
                        <div class="flex justify-between items-center mb-4 z-10 relative">
                             <div class="flex items-center gap-2">
                                <span class="h-2 w-2 rounded-full ${sentiment === 'Bullish' ? 'bg-emerald-500 box-shadow-emerald' : (sentiment === 'Bearish' ? 'bg-rose-500 box-shadow-rose' : 'bg-slate-500')}"></span>
                                <h3 class="text-lg font-bold text-slate-200 tracking-wide">${sym}</h3>
                             </div>
                             <span class="px-2.5 py-1 rounded-full text-[10px] font-bold uppercase bg-black/20 border border-white/5 text-slate-300 backdrop-blur tracking-wider">${sentiment}</span>
                        </div>
                        
                        <!-- Price Section -->
                        <div class="flex flex-col mb-4 z-10 relative">
                             <div class="text-3xl md:text-4xl font-mono font-bold text-white tracking-tighter filter drop-shadow-md">${spot}</div>
                             <div class="flex items-center gap-2 mt-1">
                                <div class="text-xs font-mono font-semibold ${priceColor} bg-black/20 px-1.5 py-0.5 rounded">
                                    ${sign}${ch.toFixed(2)} (${sign}${chp.toFixed(2)}%)
                                </div>
                             </div>
                        </div>
                        
                        <!-- Gauge Area (Compact) -->
                        <div class="relative z-10 flex justify-center py-1 mb-2 scale-90 origin-top">
                             <div id="gauge-${sym}" class="-my-6"></div>
                             
                             <!-- Overlay Score -->
                             <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none mt-2">
                                <span class="text-xl font-bold text-white tracking-tighter drop-shadow-sm">${pcr}</span>
                                <span class="text-[8px] text-slate-400 uppercase tracking-widest">PCR</span>
                             </div>
                        </div>

                        <!-- Footer Stats -->
                        <div class="grid grid-cols-2 gap-2 mt-2 px-1 border-t border-white/5 pt-3 z-10 relative">
                            <div class="text-left">
                                <div class="text-[9px] text-slate-500 uppercase tracking-wider mb-0.5 font-bold">Max Pain</div>
                                <div class="text-sm font-mono font-bold text-indigo-300">${maxPain}</div>
                            </div>
                            <div class="text-right">
                                <button onclick="goToAnalysis('${sym}')" class="text-[10px] font-bold uppercase tracking-widest text-indigo-400 hover:text-indigo-300 transition-colors flex items-center justify-end gap-1 ml-auto">
                                    Deep Dive <span class="text-lg leading-none">&rsaquo;</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });


            // Initialize Gauges
            symbols.forEach(sym => {
                const d = data[sym] || {};
                const pcr = d.pcr !== undefined ? d.pcr : 0;
                renderGauge(`gauge-${sym}`, pcr);
            });
        }

        function renderGauge(elementId, pcrValue) {
            // Normalize: 0 to 2 range.
            // Percentage: (Value / 2) * 100. Cap at 100.
            const percentage = Math.min(Math.max((pcrValue / 2) * 100, 0), 100);

            // Color Logic
            let color = '#ef4444'; // Red (Bearish) - Default
            if (pcrValue >= 0.7) color = '#f97316'; // Orange
            if (pcrValue >= 0.9) color = '#94a3b8'; // Slate (Neutral)
            if (pcrValue >= 1.1) color = '#3b82f6'; // Blue
            if (pcrValue >= 1.3) color = '#10b981'; // Green (Bullish)

            const options = {
                series: [percentage],
                chart: {
                    height: 200,
                    type: 'radialBar',
                    offsetY: -20,
                    sparkline: { enabled: true }
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -90,
                        endAngle: 90,
                        track: {
                            background: "#1e293b",
                            strokeWidth: '97%',
                            margin: 5,
                        },
                        dataLabels: {
                            show: false // We use custom overlay
                        },
                        hollow: {
                            margin: 15,
                            size: "60%"
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        shadeIntensity: 0.5,
                        gradientToColors: [color],
                        inverseColors: true,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 100]
                    }
                },
                stroke: {
                    lineCap: "round"
                },
                colors: [color],
            };

            // Check if chart already exists (for refresh)? No, we wipe container.
            const chart = new ApexCharts(document.querySelector("#" + elementId), options);
            chart.render();
        }

        function goToAnalysis(symbol) {
            const sel = document.getElementById('symbolSelect');
            sel.value = symbol;
            switchView('analysis');
        }

        // --- Render: Full Chain (Analysis) ---
        function renderFullChain(chain) {
            const tbody = document.getElementById('full-chain-body');
            tbody.innerHTML = '';

            // 1. Find ATM Index
            let atmIndex = chain.findIndex(row => row.is_atm);
            if (atmIndex === -1) atmIndex = Math.floor(chain.length / 2);

            // 2. Filter: 20 above, 20 below
            const start = Math.max(0, atmIndex - 20);
            const end = Math.min(chain.length, atmIndex + 21);
            const filteredChain = chain.slice(start, end);

            filteredChain.forEach(row => {
                const isAtm = row.is_atm;
                const tr = document.createElement('tr');
                tr.className = isAtm ? 'atm-row font-bold text-white relative z-10' : 'hover:bg-slate-800/50 border-b border-slate-800/50 transition-colors';
                if (isAtm) tr.id = "atm-row"; // Marker for scrolling

                // Helper to format
                const fmt = (n) => n ? n.toFixed(2) : '-';
                const fmtInt = (n) => n ? n.toLocaleString() : '-';
                const colorVal = (n) => n > 0 ? 'text-emerald-400' : (n < 0 ? 'text-rose-400' : 'text-slate-500');

                // Calls
                tr.innerHTML += `
                    <td class="call-bg py-2 text-slate-200 border-r border-emerald-900/10 font-mono hidden sm:table-cell">${fmtInt(row.ce_oi)}</td>
                    <td class="call-bg py-2 ${colorVal(row.ce_oich)} font-mono text-[11px] hidden sm:table-cell">${fmtInt(row.ce_oich)}</td>
                    <td class="call-bg py-2 text-slate-500 hidden md:table-cell text-[10px]">${fmtInt(row.ce_vol)}</td>
                    <td class="call-bg py-2 text-amber-200/60 hidden lg:table-cell font-mono">${fmt(row.ce_iv)}</td>
                    <td class="call-bg py-2 text-indigo-300/80 hidden lg:table-cell font-mono">${fmt(row.ce_delta)}</td>
                    <td class="call-bg py-2">${getTrendBadge(row.ce_trend)}</td>
                    <td class="call-bg py-2 font-bold text-emerald-200 text-sm border-l border-emerald-900/10 tracking-tight">${fmt(row.ce_ltp)}</td>
                    <td class="call-bg py-2 ${colorVal(row.ce_ch)} text-[11px] border-r border-slate-700/30 hidden sm:table-cell">${fmt(row.ce_ch)}</td>
                `;

                // Strike
                tr.innerHTML += `
                    <td class="py-3 font-bold bg-slate-900 text-white border-x border-slate-700 text-sm shadow-inner sticky left-0 md:static z-20">${row.strike}</td>
                `;

                // Puts
                tr.innerHTML += `
                    <td class="put-bg py-2 font-bold text-rose-200 text-sm border-l border-slate-700/30 tracking-tight">${fmt(row.pe_ltp)}</td>
                    <td class="put-bg py-2 ${colorVal(row.pe_ch)} text-[11px] border-r border-rose-900/10 hidden sm:table-cell">${fmt(row.pe_ch)}</td>
                    <td class="put-bg py-2">${getTrendBadge(row.pe_trend)}</td>
                    <td class="put-bg py-2 text-indigo-300/80 hidden lg:table-cell font-mono">${fmt(row.pe_delta)}</td>
                    <td class="put-bg py-2 text-amber-200/60 hidden lg:table-cell font-mono">${fmt(row.pe_iv)}</td>
                    <td class="put-bg py-2 text-slate-500 hidden md:table-cell text-[10px]">${fmtInt(row.pe_vol)}</td>
                    <td class="put-bg py-2 ${colorVal(row.pe_oich)} font-mono text-[11px] hidden sm:table-cell">${fmtInt(row.pe_oich)}</td>
                    <td class="put-bg py-2 text-slate-200 border-l border-rose-900/10 font-mono hidden sm:table-cell">${fmtInt(row.pe_oi)}</td>
                `;

                tbody.appendChild(tr);
            });

            // 3. Auto-Center ATM
            setTimeout(() => {
                const atmRow = document.getElementById('atm-row');
                if (atmRow) {
                    atmRow.scrollIntoView({ block: "center", behavior: "smooth" });
                }
            }, 500);
        }

        function getTrendBadge(trend) {
            if (!trend || trend === 'Neutral' || trend === '-') return '<span class="text-slate-700">-</span>';

            let code = trend.split(' ').map(w => w[0]).join('');
            let classes = "px-1.5 py-0.5 rounded text-[9px] font-bold border tracking-wider ";

            if (trend === 'Long Buildup') classes += "bg-emerald-950/40 text-emerald-400 border-emerald-800/50";
            else if (trend === 'Short Covering') classes += "bg-teal-950/40 text-teal-400 border-teal-800/50";
            else if (trend === 'Short Buildup') classes += "bg-rose-950/40 text-rose-400 border-rose-800/50";
            else if (trend === 'Long Unwinding') classes += "bg-orange-950/40 text-orange-400 border-orange-800/50";

            return `<span class="${classes}" title="${trend}">${code}</span>`;
        }

        // --- Init ---
        // Switch to overview by default, trigger default styling
        switchView('overview');

        // Auto-refresh every 3s
        setInterval(updateUI, 3000);
        setInterval(() => window.location.reload(), 300000); // Reload every 5 mins

        updateUI(); // First load

        // --- PWA Service Worker ---
        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js');
        }

        // --- Install Prompt Logic ---
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.classList.remove('hidden'); // Show button
            installBtn.classList.add('flex');
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                    installBtn.classList.add('hidden');
                }
            }
        }
        function renderSignalMatrix(data) {
            const tbody = document.getElementById('signal-matrix-body');
            const logContainer = document.getElementById('signals-container');
            if (!tbody) return;

            let rows = '';
            let logs = '';

            ['NIFTY', 'BANKNIFTY', 'FINNIFTY'].forEach(sym => {
                const d = data[sym];
                if (!d || !d.matrix) return;
                const m = d.matrix;

                // Determine Overall Sentiment
                let bullCount = 0;
                let bearCount = 0;
                [m.pcr.status, m.max_pain.status, m.oi_flow.status, m.trend.status].forEach(s => {
                    if (s === 'Bullish') bullCount++;
                    if (s === 'Bearish') bearCount++;
                });

                let action = '<span class="text-slate-500 font-mono">NEUTRAL</span>';
                let rowClass = 'hover:bg-slate-900/50 transition-colors';

                // Helper for cells
                const badge = (status, val) => {
                    let col = 'text-slate-400';
                    if (status === 'Bullish') col = 'text-emerald-400 font-bold';
                    if (status === 'Bearish') col = 'text-rose-400 font-bold';

                    // Truncate val if too long (e.g., trend text)
                    let dispVal = val;
                    if (String(val).includes(' vs ')) { // Trend count
                        dispVal = val.replace(' vs ', '/');
                    } else if (typeof val === 'string' && val.length > 8) {
                        if (val.includes('Writing')) dispVal = val.includes('PE') ? 'PE Wrt' : 'CE Wrt';
                        else dispVal = val.substring(0, 6) + '..';
                    }

                    return `<div class="${col} whitespace-nowrap">${dispVal}</div><div class="text-[8px] text-slate-600 uppercase tracking-tighter">${status.substring(0, 4)}</div>`;
                };

                rows += `
                    <tr class="${rowClass} border-b border-slate-800 last:border-0">
                        <td class="p-2 font-bold text-white align-middle">${sym.substring(0, 4)} <div class="text-[9px] text-slate-500">${d.spot}</div></td>
                        <td class="p-2 text-center align-middle">${badge(m.pcr.status, m.pcr.val)}</td>
                        <td class="p-2 text-center align-middle">${badge(m.max_pain.status, m.max_pain.val)}</td>
                        <td class="p-2 text-center align-middle">${badge(m.oi_flow.status, m.oi_flow.val)}</td>
                        <td class="p-2 text-center align-middle">${badge(m.trend.status, m.trend.val)}</td>
                        <td class="p-2 text-right align-middle">${action}</td>
                    </tr>
                 `;

                // Accumulate logs
                if (d.alerts && d.alerts.length > 0) {
                    d.alerts.forEach(alert => {
                        const isBull = alert.type === 'BULLISH';
                        const color = isBull ? 'emerald' : 'rose';
                        logs += `
                            <div class="glass border-l-4 border-${color}-500 p-4 rounded-r-lg shadow-sm flex justify-between items-center group">
                                <div>
                                    <h4 class="font-bold text-slate-200 text-sm"><span class="text-${color}-400 mr-2">[${sym}]</span> ${alert.strategy}</h4>
                                    <p class="text-xs text-slate-400 mt-1 opacity-80 group-hover:opacity-100 transition-opacity">${alert.desc}</p>
                                </div>
                                <span class="px-2 py-1 bg-${color}-500/10 text-${color}-400 text-[10px] font-bold rounded uppercase border border-${color}-500/20">${alert.type}</span>
                            </div>`;
                    });
                }
            });

            tbody.innerHTML = rows;
            // Logs are now handled by history API
            // logContainer.innerHTML = logs || '<div class="text-slate-500 text-sm text-center italic py-2">No active alerts.</div>';
        }

        async function fetchSignalHistory() {
            try {
                const res = await fetch('/api/signal_history');
                const history = await res.json();
                const container = document.getElementById('signal-history'); // Fixed ID
                if (!container) return;

                // Let's iterate all keys to show a combined feed or just current symbol
                // Showing ALL is better for a "Feed"
                let allLogs = [];
                for (const [sym, logs] of Object.entries(history)) {
                    logs.forEach(l => {
                        l.symbol = sym;
                        allLogs.push(l);
                    });
                }

                // Sort by time desc
                allLogs.sort((a, b) => new Date(b.time) - new Date(a.time));

                let html = '';
                if (allLogs.length > 0) {
                    allLogs.slice(0, 50).forEach(log => {
                        const isBull = log.type === 'BULLISH';
                        // Colors: Bull=Emerald, Bear=Rose
                        const color = isBull ? 'emerald' : 'rose';
                        const timeParts = log.time.split(' ')[1].split(':');
                        const shortTime = `${timeParts[0]}:${timeParts[1]}`;

                        html += `
                            <div class="glass border-l-4 border-${color}-500 p-3 rounded-r-lg shadow-sm flex items-start gap-3 group hover:bg-white/5 transition-all">
                                <div class="text-[10px] items-center text-slate-500 font-mono pt-1 min-w-[35px]">${shortTime}</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-slate-200 text-xs flex justify-between items-center">
                                        <span>${log.symbol}</span>
                                        <span class="px-1.5 py-0.5 bg-${color}-500/10 text-${color}-400 text-[9px] font-bold rounded uppercase border border-${color}-500/20">${log.type}</span>
                                    </h4>
                                    <p class="text-[11px] text-slate-400 mt-0.5 leading-snug">${log.desc}</p>
                                </div>
                            </div>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="text-slate-500 text-xs text-center italic py-4">No active signals yet.</div>';
                }
            } catch (e) {
                console.error("History fetch failed", e);
            }
        }

        // --- Signal Cockpit (Gauges) ---
        async function updateSignals() {
            try {
                // We fetch the same API but now it returns the 'matrix' which is our 'signal_card'
                // Actually wait, existing logic fetches 'market_data' via /api/option_chain
                const res = await fetch('/api/option_chain');
                const data = await res.json();

                if (data) {
                    ['NIFTY', 'BANKNIFTY', 'FINNIFTY'].forEach(sym => {
                        if (data[sym] && data[sym].matrix) {
                            renderSignalGauge(sym, data[sym].matrix);
                        }
                    });
                }
            } catch (e) {
                console.error("Signal fetch error:", e);
            }
        }

        let signalCharts = {};

        function renderSignalGauge(symbol, card) {
            const containerId = `#signal-${symbol}`; // We need to add these div IDs in HTML
            const el = document.querySelector(containerId);
            if (!el) return;

            // Normalize Score (-10 to 10) -> (0 to 100) for Gauge
            // -10 = 0%, 0 = 50%, 10 = 100%
            const seriesVal = ((card.score + 10) / 20) * 100;

            // Color Logic
            let color = '#94a3b8'; // Neutral Slate
            if (card.score >= 5) color = '#10b981'; // Emerald
            else if (card.score >= 2) color = '#2dd4bf'; // Teal
            else if (card.score <= -5) color = '#f43f5e'; // Rose
            else if (card.score <= -2) color = '#f97316'; // Orange

            const options = {
                series: [seriesVal],
                chart: {
                    height: 250,
                    type: 'radialBar',
                    fontFamily: 'Outfit, sans-serif',
                    animations: { enabled: true, speed: 800 }
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -90,
                        endAngle: 90,
                        track: {
                            background: "#334155",
                            strokeWidth: '97%',
                            margin: 5,
                        },
                        dataLabels: {
                            show: true,
                            name: {
                                show: true,
                                fontSize: '14px',
                                color: '#94a3b8',
                                offsetY: -10
                            },
                            value: {
                                show: false
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        shadeIntensity: 0.5,
                        gradientToColors: [color],
                        inverseColors: true,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 100]
                    }
                },
                stroke: { lineCap: 'round' },
                labels: [card.action], // The text inside
            };

            if (signalCharts[symbol]) {
                signalCharts[symbol].updateOptions({
                    labels: [card.action],
                    fill: { gradient: { gradientToColors: [color] } } // Update color dynamically
                });
                signalCharts[symbol].updateSeries([seriesVal]);
            } else {
                signalCharts[symbol] = new ApexCharts(el, options);
                signalCharts[symbol].render();
            }

            // Update Reasons Text below chart
            const reasonEl = document.querySelector(`#reasons-${symbol}`);
            if (reasonEl) {
                reasonEl.innerHTML = card.reasons.map(r =>
                    `<div class="text-[10px] text-slate-400 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-${card.color}-500"></span> ${r}
                     </div>`
                ).join('');
            }
        }

        // Call updateSignals periodically or link it to existing loop
        setInterval(updateSignals, 5000);
        updateSignals();

        // --- Charting ---
        let charts = {
            'NIFTY': null,
            'BANKNIFTY': null,
            'FINNIFTY': null
        };

        async function renderAllCharts() {
            ['NIFTY', 'BANKNIFTY', 'FINNIFTY'].forEach(sym => fetchAndRenderChart(sym));
        }

        async function fetchAndRenderChart(symbol) {
            try {
                const res = await fetch(`/api/oi_history?symbol=${symbol}`);
                const data = await res.json();

                const containerId = `#chart-${symbol}`;
                const container = document.querySelector(containerId);

                if (!data || data.length === 0) {
                    if (container) container.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-slate-600 text-xs">No chart data for ' + symbol + '</div>';
                    return;
                }

                // --- Pre-Process Data for Full Day Axis (09:15 - 15:30) ---
                // Generate all minute slots
                const fullTimeSlots = [];
                let start = new Date();
                start.setHours(9, 15, 0, 0);
                const end = new Date();
                end.setHours(15, 30, 0, 0);

                while (start <= end) {
                    const hh = start.getHours().toString().padStart(2, '0');
                    const mm = start.getMinutes().toString().padStart(2, '0');
                    fullTimeSlots.push(`${hh}:${mm}`);
                    start.setMinutes(start.getMinutes() + 1);
                }

                // Map fetched data to full timeline
                const dataMap = {};
                data.forEach(d => {
                    const t = d.time.split(' ')[1].substring(0, 5);
                    dataMap[t] = d;
                });

                const categories = fullTimeSlots;
                const peChg = fullTimeSlots.map(t => dataMap[t] ? dataMap[t].pe_change : null);
                const ceChg = fullTimeSlots.map(t => dataMap[t] ? dataMap[t].ce_change : null);
                const prices = fullTimeSlots.map(t => dataMap[t] ? dataMap[t].price : null);

                const options = {
                    series: [
                        { name: 'Put (Bull)', type: 'line', data: peChg },
                        { name: 'Call (Bear)', type: 'line', data: ceChg },
                        { name: 'Spot Price', type: 'area', data: prices }
                    ],
                    chart: {
                        height: '100%',
                        type: 'line',
                        fontFamily: 'Outfit, sans-serif',
                        background: 'transparent',
                        toolbar: { show: false },
                        animations: { enabled: true, easing: 'easeinout', speed: 800 }
                    },
                    colors: ['#34d399', '#f43f5e', '#fbbf24'], // Emerald, Rose, Amber (Spot)
                    stroke: { curve: 'smooth', width: [2, 2, 4], dashArray: [0, 0, 0] },
                    fill: {
                        type: ['solid', 'solid', 'solid'], // Solid lines for all
                        opacity: [1, 1, 1]
                    },
                    dataLabels: { enabled: false },
                    grid: {
                        borderColor: '#334155',
                        strokeDashArray: 3,
                        padding: { top: 10, right: 30, bottom: 10, left: 20 }
                    },
                    xaxis: {
                        categories: categories,
                        labels: {
                            show: true,
                            style: { colors: '#94a3b8', fontSize: '11px', fontFamily: 'JetBrains Mono' },
                            rotate: 0,
                            hideOverlappingLabels: true,
                            formatter: function (val) {
                                // Only show 09:15, 10:00, 11:00... 15:30
                                if (!val) return '';
                                if (val === '09:15' || val === '15:30') return val;
                                if (val.endsWith(':00')) return val; // Hourly ticks
                                return '';
                            }
                        },
                        axisBorder: { show: false },
                        axisTicks: { show: false },
                        tooltip: { enabled: false },
                        tickAmount: undefined // Let formatter handle it
                    },
                    yaxis: [
                        {
                            seriesName: 'Put (Bull)',
                            show: true,
                            labels: {
                                style: { colors: '#94a3b8', fontSize: '10px', fontFamily: 'JetBrains Mono' },
                                formatter: (val) => val ? (val / 1000).toFixed(0) + 'k' : ''
                            },
                        },
                        {
                            seriesName: 'Call (Bear)',
                            show: false,
                        },
                        {
                            seriesName: 'Spot Price',
                            opposite: true,
                            show: true,
                            labels: {
                                style: { colors: '#fbbf24', fontSize: '11px', fontFamily: 'JetBrains Mono', fontWeight: 'bold' },
                                formatter: (val) => val ? val.toFixed(0) : ''
                            }
                        }
                    ],
                    theme: { mode: 'dark' },
                    legend: { show: false },
                    tooltip: {
                        theme: 'dark',
                        shared: true,
                        intersect: false,
                        x: { show: true },
                        y: {
                            formatter: function (y, { seriesIndex, w }) {
                                if (y === null) return "";
                                if (seriesIndex === 2) return y.toFixed(2); // Price
                                return (y / 1000).toFixed(1) + "k";
                            }
                        },
                        style: { fontSize: '12px', fontFamily: 'Outfit, sans-serif' },
                        marker: { show: true },
                        fixed: { enabled: false, position: 'topRight', offsetX: 0, offsetY: 0 }
                    }
                };

                if (charts[symbol]) {
                    charts[symbol].updateOptions({
                        xaxis: { categories: categories }
                    });
                    charts[symbol].updateSeries([
                        { data: peChg },
                        { data: ceChg },
                        { data: prices }
                    ]);
                } else {
                    charts[symbol] = new ApexCharts(document.querySelector(containerId), options);
                    charts[symbol].render();
                }

            } catch (e) {
                console.error(`Chart Error ${symbol}:`, e);
            }
        }
    </script>
</body>

</html>